GET /search?q=site:segmentfault.com%20Best%20practices%20for%20exporting%20and%20importing%20data%20from%20Amazon%20Aurora%20MySQL%20to%20Amazon%20S3%20by%20Suresh%20Patnam%20and%20Mahesh%20Goyal%20|%20on%2015%20JUN%202020%20|%20in%20Amazon%20Aurora,%20MySQL%20Compatible%20|%20Permalink%20|%20%20Comments%20|%20%20Share%20You%20can%20build%20highly%20distributed%20applications%20using%20a%20multitude%20of%20purpose-built%20databases%20by%20decoupling%20complex%20applications%20into%20smaller%20pieces,%20which%20allows%20you%20to%20choose%20the%20right%20database%20for%20the%20right%20job.%20Amazon%20Aurora%20is%20the%20preferred%20choice%20for%20OLTP%20workloads.%20Aurora%20makes%20it%20easy%20to%20set%20up,%20operate,%20and%20scale%20a%20relational%20database%20in%20the%20cloud.%20%20This%20post%20demonstrates%20how%20you%20can%20export%20and%20import%20the%20data%20from%20Aurora%20MySQL%20to%20Amazon%20Simple%20Storage%20Service%20(Amazon%20S3)%20and%20shares%20associated%20best%20practices.%20Export%20import%20data%20to%20Amazon%20S3%20feature%20is%20also%20available%20for%20Amazon%20Aurora%20PostgreSQL.%20This%20blog%20post%20focuses%20on%20Amazon%20Aurora%20MySQL.%20%20Overview%20of%20Aurora%20and%20Amazon%20S3%20Aurora%20is%20a%20MySQL%20and%20PostgreSQL-compatible%20relational%20database%20built%20for%20the%20cloud,%20which%20combines%20the%20performance%20and%20availability%20of%20traditional%20enterprise%20databases%20with%20the%20simplicity%20and%20cost-effectiveness%20of%20open-source%20databases.%20%20Amazon%20S3%20is%20an%20object%20storage%20service%20that%20offers%20industry-leading%20scalability,%20data%20availability,%20security,%20and%20performance.%20This%20means%20customers%20of%20all%20sizes%20and%20industries%20can%20use%20it%20to%20store%20and%20protect%20any%20amount%20of%20data.%20%20Prerequisites%20Before%20you%20get%20started,%20complete%20the%20following:%20%20Launch%20an%20Aurora%20MySQL%20DB%20cluster.%20You%20can%20also%20use%20an%20existing%20cluster.%20Launch%20an%20Amazon%20EC2%20instance%20that%20you%20installed%20the%20MySQL%20client%20on.%20You%20can%20also%20use%20MySQL%20Workbench%20for%20this%20purpose.%20Create%20the%20following%20required%20Identity%20and%20Access%20Management%20(IAM)%20policies%20and%20roles:%20Create%20an%20IAM%20policy%20with%20the%20least-restricted%20privilege%20to%20the%20resources%20in%20the%20following%20code%20and%20name%20it%20aurora-s3-access-pol.%20The%20policy%20must%20have%20access%20to%20the%20S3%20bucket%20where%20the%20files%20are%20stored%20(for%20this%20post,%20sample-loaddata01).%20{%20%20%20%20%20%22Version%22:%20%222012-10-17%22,%20%20%20%20%20%22Statement%22:%20[%20%20%20%20%20%20%20%20%20{%20%20%20%20%20%20%20%20%20%20%20%20%20%22Effect%22:%20%22Allow%22,%20%20%20%20%20%20%20%20%20%20%20%20%20%22Action%22:%20[%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22s3:GetObject%22,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22s3:AbortMultipartUpload%22,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22s3:DeleteObject%22,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22s3:ListMultipartUploadParts%22,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22s3:PutObject%22,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22s3:ListBucket%22%20%20%20%20%20%20%20%20%20%20%20%20%20],%20%20%20%20%20%20%20%20%20%20%20%20%20%22Resource%22:%20[%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22arn:aws:s3:::sample-loaddata01/*%22,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22arn:aws:s3:::sample-loaddata01%22%20%20%20%20%20%20%20%20%20%20%20%20%20]%20%20%20%20%20%20%20%20%20}%20%20%20%20%20]%20}%20Create%20an%20IAM%20role%20and%20modify%20the%20trust%20relationship%20according%20to%20the%20following%20code.%20AssumeRole%20allows%20Aurora%20to%20access%20other%20AWS%20services%20on%20your%20behalf.%20{%20%22Version%22:%20%222012-10-17%22,%20%20%20%22Statement%22:%20[%20%20%20%20%20{%20%20%20%20%20%20%20%22Effect%22:%20%22Allow%22,%20%20%20%20%20%20%20%22Principal%22:%20{%20%20%20%20%20%20%20%20%20%22Service%22:%20%22rds.amazonaws.com%22%20%20%20%20%20%20%20},%20%20%20%20%20%20%20%22Action%22:%20%22sts:AssumeRole%22%20%20%20%20%20}%20%20%20]%20}%20Attach%20the%20policy%20aurora-s3-access-pol%20from%20the%20previous%20step.%20For%20this%20post,%20the%20role%20is%20named%20s3-demo-access-role%20and%20the%20role%20ARN%20is%20arn:aws:iam::123456789012:role/aurora-s3-access-role.%20Create%20and%20assign%20parameter%20groups%20for%20the%20cluster:%20Create%20a%20custom%20parameter%20group%20using%20the%20AWS%20Command%20Line%20Interface%20(AWS%20CLI).%20See%20the%20following%20code:%20aws%20rds%20create-db-cluster-parameter-group%20\%20--db-cluster-parameter-group-name%20aurora-cluster-para-grp%20\%20--db-parameter-group-family%20aurora5.6%20\%20--description%20%22cluster%20parameter%20group%20for%20s3%20copy%22%20%20Modify%20the%20parameter%20group%20to%20edit%20the%20value%20of%20the%20aurora_default_s3_role%20parameter%20to%20the%20IAM%20role%20s3-demo-access-role.%20See%20the%20following%20code:%20aws%20rds%20modify-db-cluster-parameter-group%20\%20%20%20--db-cluster-parameter-group-name%20aurora-cluster-para-grp%20\%20%20%20--parameters%20%22ParameterName=aurora_default_s3_role,ParameterValue=arn:aws:iam::123456789012:role/aurora-s3-access-role,ApplyMethod=immediate%22%20You%20can%20map%20the%20IAM%20role%20to%20the%20aurora_select_into_s3_role%20parameter%20to%20allow%20only%20data%20export%20or%20map%20the%20aurora_load_from_s3_role%20parameter%20to%20allow%20only%20data%20import%20from%20the%20S3%20bucket.%20If%20the%20IAM%20role%20isn%E2%80%99t%20specified%20for%20these%20two%20parameters,%20Aurora%20uses%20the%20IAM%20role%20specified%20in%20aws_default_s3_role%20for%20both%20export%20and%20import.%20%20Modify%20the%20Aurora%20cluster%20and%20associate%20the%20newly%20created%20parameter%20group.%20See%20the%20following%20code:%20aws%20rds%20modify-db-cluster%20\%20%20%20--db-cluster-identifier%20database-1%20\%20%20%20--db-cluster-parameter-group-name%20aurora-cluster-para-grp%20\%20%20%20--apply-immediately%20The%20apply-immediately%20code%20triggers%20modification%20and%20asynchronously%20applies%20changes%20as%20soon%20as%20possible%20regardless%20of%20the%20PreferredMaintenanceWindow%20on%20the%20DB%20cluster.%20%20Associate%20the%20IAM%20role%20to%20the%20cluster.%20This%20allows%20database%20users%20in%20an%20Aurora%20DB%20cluster%20to%20access%20the%20S3%20bucket.%20See%20the%20following%20code:%20aws%20rds%20add-role-to-db-cluster%20\%20%20%20%20%20--db-cluster-identifier%20database-1%20\%20%20%20%20%20--role-arn%20arn:aws:iam::123456789012:role/aurora-s3-access-role%20Reboot%20the%20primary%20instance%20in%20the%20cluster%20to%20apply%20the%20changes.%20See%20the%20following%20code:%20aws%20rds%20reboot-db-instance%20\%20%20%20%20%20%20%20--db-instance-identifier%20database-1-instance-1%20You%E2%80%99re%20now%20ready%20to%20explore%20the%20following%20use%20cases%20of%20exporting%20and%20importing%20data.%20%20Exporting%20data%20from%20Aurora%20MySQL%20to%20Amazon%20S3%20To%20export%20your%20data,%20complete%20the%20following%20steps:%20%20Connect%20to%20the%20cluster%20as%20the%20master%20user.%20By%20default,%20the%20master%20user%20has%20permission%20to%20export%20and%20import%20data%20from%20Amazon%20S3.%20For%20this%20post,%20you%20create%20a%20test%20user%20with%20the%20least-required%20permission%20to%20export%20data%20to%20the%20S3%20bucket.%20See%20the%20following%20code:%20$%20mysql%20-h%20database-1.cluster-xxxxxxxxxxxx.us-west-2.rds.amazonaws.com%20-D%20sampledb01%20-P%203306%20-u%20admin01%20-p%20Create%20the%20user%20testuser%20and%20grant%20the%20required%20privileges%20to%20the%20user%20on%20the%20database.%20This%20post%20uses%20sampledb01.%20See%20the%20following%20code:%20MySQL%3E%20create%20user%20%27testuser%27@%27%%27%20identified%20by%20%27Password%27;%20MySQL%3E%20grant%20select%20on%20sampledb01.*%20to%20%27testuser%27@%27%%27;%20Grant%20the%20SELECT%20INTO%20S3%20privilege%20to%20testuser%20with%20the%20following%20code:%20MySQL%3E%20grant%20SELECT%20INTO%20S3%20on%20*.*%20to%20%27testuser%27@%27%%27;%20Log%20in%20to%20the%20cluster%20as%20testuser:%20$%20mysql%20-h%20database-1.cluster-xxxxxxxxxxxx.us-west-2.rds.amazonaws.com%20-D%20sampledb01%20-P%203306%20-u%20testuser%20-p%20For%20this%20post,%20you%20export%20the%20lineitem%20table%20to%20the%20S3%20bucket.%20You%20can%20use%20any%20existing%20table%20in%20your%20database%20(preferably%20small%20size)%20to%20test%20this%20feature.%20See%20the%20following%20code:%20MySQL%3E%20describe%20lineitem;%20+-----------------+-------------+------+-----+---------+-------+%20|%20Field%20%20%20%20%20%20%20%20%20%20%20|%20Type%20%20%20%20%20%20%20%20|%20Null%20|%20Key%20|%20Default%20|%20Extra%20|%20+-----------------+-------------+------+-----+---------+-------+%20|%20orderkey%20%20%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20linenumber%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20custkey%20%20%20%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20partkey%20%20%20%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20suppkey%20%20%20%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20orderdate%20%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20orderpriority%20%20%20|%20varchar(15)%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20shippriority%20%20%20%20|%20varchar(1)%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20quantity%20%20%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20extendedprice%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20ordertotalprice%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20discount%20%20%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20revenue%20%20%20%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20supplycost%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20tax%20%20%20%20%20%20%20%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20commitdate%20%20%20%20%20%20|%20int(11)%20%20%20%20%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20|%20lshipmode%20%20%20%20%20%20%20|%20varchar(10)%20|%20NO%20%20%20|%20%20%20%20%20|%20NULL%20%20%20%20|%20%20%20%20%20%20%20|%20+-----------------+-------------+------+-----+---------+-------+%20%20The%20following%20screenshot%20displays%20a%20few%20records%20from%20the%20lineitem%20table.%20%20%20To%20export%20data%20from%20the%20Aurora%20table%20to%20the%20S3%20bucket,%20use%20the%20SELECT%20INTO%20OUTFILE%20S3%20The%20following%20statement%20exports%20the%20entire%20table%20to%20the%20S3%20bucket.%20If%20you%E2%80%99re%20trying%20this%20feature%20out%20for%20the%20first%20time,%20consider%20using%20the%20LIMIT%20clause%20for%20a%20larger%20table.%20See%20the%20following%20code:%20MySQL%3E%20SELECT%20*%20FROM%20lineitem%20INTO%20OUTFILE%20S3%20%20%27s3://sample-loaddata01/unload-data/file%27%20FIELDS%20TERMINATED%20BY%20%27,%27%20LINES%20TERMINATED%20BY%20%27\n%27;%20Query%20OK,%2050000000%20rows%20affected%20(3%20min%2037.05%20sec)%20The%20following%20code%20shows%20the%20exported%20file%20in%20the%20S3%20bucket.%20The%20default%20file%20size%20threshold%20is%206%20GB.%20Because%20the%20data%20selected%20by%20the%20statement%20is%20less%20than%20the%20file%20size%20threshold,%20a%20single%20file%20is%20created.%20%20$aws%20s3%20ls%20s3://sample-loaddata01/unload-data%20--recursive%20--human-readable%20--summarize%202020-04-29%2000:10:17%20%20%20%204.7%20GiB%20unload-data/file.part_00000%20If%20you%20need%20the%20file%20size%20to%20be%20smaller%20than%206%20GB,%20you%20can%20identify%20a%20column%20to%20split%20the%20table%20data%20into%20small%20portions%20and%20run%20multiple%20SELECT%20INTO%20OUTFILE%20statements%20(using%20the%20WHERE%20condition).%20It%E2%80%99s%20best%20to%20do%20this%20when%20the%20amount%20of%20data%20selected%20is%20more%20than%2025%20GB.%20%20Importing%20data%20from%20Amazon%20S3%20to%20Aurora%20MySQL%20In%20this%20section,%20you%20load%20the%20data%20back%20to%20the%20Aurora%20table%20from%20the%20Amazon%20S3%20file.%20Complete%20the%20following%20steps:%20%20Grant%20the%20LOAD%20FROM%20S3%20privilege%20to%20testuser.%20See%20the%20following%20code:%20MySQL%3E%20grant%20LOAD%20FROM%20S3%20on%20*.*%20to%20%27testuser%27@%27%%27;%20Use%20LOAD%20DATA%20FROM%20S3%20to%20import%20the%20data%20file%20from%20an%20Amazon%20S3%20prefix.%20See%20the%20following%20code:%20MySQL%20%3E%20LOAD%20DATA%20FROM%20S3%20PREFIX%20%27s3://sample-loaddata01/unload-data/file%27%20INTO%20TABLE%20lineitem%20%20FIELDS%20TERMINATED%20BY%20%27,%27%20%20%20%20LINES%20TERMINATED%20BY%20%27\n%27%20(orderkey,linenumber,custkey,partkey,suppkey,orderdate,orderpriority,shippriority,quantity,extendedprice,ordertotalprice,discount,revenue,supplycost,tax,commitdate,shipmode);%20Query%20OK,%2050000000%20rows%20affected%20(%208%20min%2016%20sec)%20Verify%20the%20loaded%20files%20using%20the%20aurora_s3_load_history%20system%20table.%20See%20the%20following%20code:%20MySQL%3E%20select%20*%20from%20mysql.aurora_s3_load_history%20order%20by%20load_timestamp%20desc%20limit%201\G;%20%20***************************%201.%20row%20***********************%20%20%20load_prefix:%20s3://sample-loaddata01/unload-data/file%20%20%20%20%20%20file_name:%20unload-data/file.part_00000%20version_number:%20%20%20%20bytes_loaded:%205052058881%20load_timestamp:%202020-05-05%2018:09:53%20Best%20practices HTTP/1.1
Host: www.bing.com
Sec-Ch-Ua: "Not.A/Brand";v="8", "Chromium";v="114", "Google Chrome";v="114"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Full-Version: "114.0.5735.199"
Sec-Ch-Ua-Arch: "x86"
Sec-Ch-Ua-Platform: "Windows"
Sec-Ch-Ua-Platform-Version: "15.0.0"
Sec-Ch-Ua-Model: ""
Sec-Ch-Ua-Bitness: "64"
Sec-Ch-Ua-Full-Version-List: "Not.A/Brand";v="8.0.0.0", "Chromium";v="114.0.5735.199", "Google Chrome";v="114.0.5735.199"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: cross-site
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://segmentfault.com/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7

